<html>
  <head>
    <meta name="viewport" content="width=device-width" />
    <meta charset="utf-8" />
    <link rel="manifest" href="manifest.json" />
    <link rel="stylesheet" href="book.css" />
    <link rel="stylesheet" href="viewer/styles.css" />
    <script src="book.bin.js"></script>
    <script src="viewer.bin.js"></script>
    <script>
      function makeTOC(chapters) {
        let s = "<ol>";
        for (const c of chapters) {
          s += `<li><a href="${c.href()}">` + c.title() + "</a>";
          if (c.children().length > 0) {
            s += makeTOC(c.children());
          }
          s += "</li>";
        }
        s += "</ol>";
        return s;
      }

      function main() {
        const containers = {
          toc: document.querySelector("#toc"),
          text: document.querySelector("#main"),
          file: document.querySelector("#file")
        };
        const menu = document.querySelector("#menu");

        /**
         * The book that is currently loaded.
         */
        let book;

        containers.toc.addEventListener("click", function(event) {
          // Close the menu when a chapter is selected in the menu.
          if (event.target.tagName.toLowerCase() == "a") {
            closeMenu();
          }
        });

        function closeMenu() {
          menu.classList.remove("open");
        }

        async function renderTOC() {
          containers.toc.innerHTML = makeTOC(await book.toc());
        }

        function pageHTML(page, number) {
          return `<div class="pagenumber">${number}</div>` + page;
        }

        async function loadBook() {
          const input = containers.file;
          const data = input.files[0];
          if (!data) {
            return;
          }

          containers.text.innerHTML = "Loading " + input.files[0].name;

          // No need in FileReader, the underlying library takes care of it.
          book = await epub.load(data, viewer.filters.apply);

          const pager = book.pager();
          pager.onConvertProgress(function(progress) {
            containers.text.innerHTML =
              "Loading " +
              input.files[0].name +
              ": " +
              Math.round(progress * 100) +
              "%";
          });

          await renderTOC();
          containers.text.lang = "en";

          const pages = await pager.all();
          containers.text.innerHTML = pages
            .map(function(page, index) {
              return pageHTML(page, index + 1);
            })
            .join("");
          makeHyphens(containers.text);
        }

        loadBook();

        containers.file.addEventListener("change", function() {
          closeMenu();
          loadBook();
        });

        menu
          .querySelector("[data-toggle]")
          .addEventListener("click", function(event) {
            menu.classList.toggle("open");
          });

        containers.text.addEventListener("dblclick", function(event) {
          if (event.target.tagName.toLowerCase() !== "img") {
            return;
          }
          window.open(event.target.src);
        });
      }

      function makeHyphens(root) {
        if (hyphensSupported()) {
          return;
        }
        for (const node of root.querySelectorAll(
          "p, span, b, strong, em, i, blockquote"
        )) {
          for (const ch of node.childNodes) {
            if (ch.nodeType != 3) {
              continue;
            }
            ch.textContent = viewer.hyphenate(ch.textContent);
          }
        }
      }

      function hyphensSupported() {
        return (
          navigator.userAgent.indexOf("Firefox") > 0 &&
          navigator.userAgent.indexOf("Chrome") < 0
        );
      }
    </script>
  </head>
  <body>
    <div id="menu">
      <div>
        <input type="file" id="file" />
        <div id="toc"></div>
      </div>
      <button data-toggle>Toggle</button>
    </div>
    <div id="main"></div>
    <script>
      main();
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("service-worker.js");
      }
    </script>
  </body>
</html>
