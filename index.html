<html>
  <head>
    <meta name="viewport" content="width=device-width" />
    <meta charset="utf-8" />
    <link rel="manifest" href="manifest.json" />
    <link rel="stylesheet" href="book.css" />
    <style>
      html {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }
      body {
        display: flex;
        flex-direction: column;
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #main {
        flex: 1;
        border-width: 0;
        hyphens: auto;
        -webkit-hyphens: auto;
      }

      #menu {
        position: fixed;
        right: 0;
        bottom: 0;
        transition: all 0.2s;
      }
      #menu.open {
        width: 90%;
        height: 80%;
        background-color: royalblue;
      }

      #menu [data-toggle] {
        border-radius: 6em 0 0 0;
        border-width: 0;
        background-color: #4d75ed;
        width: 6em;
        height: 6em;
        position: absolute;
        right: 0;
        bottom: 0;
        color: transparent;
      }

      #menu > div {
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      #menu:not(.open) > div {
        display: none;
      }

      #toc {
        flex: 1;
        overflow: scroll;
        padding: 1em;
      }
      #toc ol {
        list-style-type: none;
        margin: 0;
        padding: 0;
      }
      #toc ol ol {
        margin-left: 1.5em;
      }
      #toc li {
        margin: 1em 0;
        color: #d8def0;
        font-weight: bold;
        font-family: sans-serif;
      }
      #toc a {
        text-decoration: none;
        color: inherit;
      }
    </style>
    <script src="book.bin.js"></script>
    <script>
      function makeTOC(chapters) {
        let s = "<ol>";
        for (const c of chapters) {
          s += `<li><a href="${c.href()}">` + c.title() + "</a>";
          if (c.children().length > 0) {
            s += makeTOC(c.children());
          }
          s += "</li>";
        }
        s += "</ol>";
        return s;
      }

      function main() {
        const containers = {
          toc: document.querySelector("#toc"),
          text: document.querySelector("#main"),
          file: document.querySelector("#file")
        };
        const menu = document.querySelector("#menu");

        /**
         * The book that is currently loaded.
         */
        let book;

        containers.toc.addEventListener("click", function(event) {
          // Close the menu when a chapter is selected in the menu.
          if (event.target.tagName.toLowerCase() == "a") {
            closeMenu();
          }
        });

        function closeMenu() {
          menu.classList.remove("open");
        }

        async function renderTOC() {
          containers.toc.innerHTML = makeTOC(await book.toc());
        }

        async function loadBook() {
          const input = containers.file;
          const data = input.files[0];
          if (!data) {
            return;
          }

          containers.text.innerHTML = "Loading " + input.files[0].name;

          // No need in FileReader, the underlying library takes care of it.
          book = await epub.Book.load(data);

          await renderTOC();
          containers.text.lang = "en";
          containers.text.innerHTML = await book.convert();
        }

        loadBook();

        containers.file.addEventListener("change", function() {
          closeMenu();
          loadBook();
        });

        menu
          .querySelector("[data-toggle]")
          .addEventListener("click", function(event) {
            menu.classList.toggle("open");
          });

        containers.text.addEventListener("dblclick", function(event) {
          if (event.target.tagName.toLowerCase() !== "img") {
            return;
          }
          window.open(event.target.src);
        });
      }
    </script>
  </head>
  <body>
    <div id="main"></div>
    <div id="menu">
      <div>
        <input type="file" id="file" />
        <div id="toc"></div>
      </div>
      <button data-toggle>Toggle</button>
    </div>
    <script>
      main();
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("service-worker.js");
      }
    </script>
  </body>
</html>
