<html>
  <head></head>
  <meta name="viewport" content="width=device-width" />
  <style>
    html {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      display: flex;
      flex-direction: column;
      height: 100%;
      margin: 0;
      padding: 0;
    }
    iframe {
      flex: 1;
      border-width: 0;
    }

    #menu {
      position: fixed;
      right: 0;
      bottom: 0;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
    }
    #menu.open {
      width: 90%;
      height: 80%;
      background-color: royalblue;
    }
    #menu [data-toggle] {
      border-radius: 6em 0 0 0;
      background-color: royalblue;
      width: 6em;
      height: 6em;
      position: absolute;
      right: 0;
      bottom: 0;
    }
    #menu:not(.open) > div {
      display: none;
    }

    #menu #toc {
      flex: 1;
      overflow: scroll;
    }
    #toc ol {
      list-style-type: none;
      margin: 0;
      padding: 0;
    }
    #toc ol ol {
      margin-left: 1.5em;
    }
  </style>
  <script src="book.bin.js"></script>
  <script>
    function makeTOC(chapters) {
      let s = "<ol>";
      for (const c of chapters) {
        s += "<li>" + c.title();
        if (c.children().length > 0) {
          s += makeTOC(c.children());
        }
        s += "</li>";
      }
      s += "</ol>";
      return s;
    }

    async function renderTOC(book, container) {
      const s = makeTOC(await book.toc());
      container.innerHTML = s;
    }

    async function renderContent(book, view) {
      const r = await book.convert();
      view.contentDocument.body.innerHTML = r;

      view.contentDocument.querySelector("head").innerHTML +=
        '<link rel="stylesheet" href="book.css">';

      view.contentDocument.body.lang = "en";
      const s = document.createElement("script");
      s.src = "hyphens.js";
      view.contentDocument.body.appendChild(s);
    }

    function main() {
      const form = document.querySelector("form");
      const view = document.querySelector("#main");
      const toc = document.querySelector("#toc");
      const menu = document.querySelector("#menu");

      form.addEventListener("submit", function(event) {
        event.preventDefault();
        const input = event.target.querySelector("input");
        const reader = new FileReader();
        reader.onload = function(event) {
          load(reader.result);
        };
        reader.readAsBinaryString(input.files[0]);
      });

      menu
        .querySelector("[data-toggle]")
        .addEventListener("click", function(event) {
          menu.classList.toggle("open");
        });

      async function load(result) {
        const book = await epub.Book.load(result);

        renderTOC(book, toc);
        renderContent(book, view);
      }
    }
  </script>
  <body>
    <iframe id="main"></iframe>
    <div id="menu">
      <div>
        <form>
          <input type="file" name="file" />
          <button>Open</button>
        </form>
        <div id="toc"></div>
      </div>
      <button data-toggle>Toggle</button>
    </div>
    <script>
      main();
    </script>
  </body>
</html>
