<html>
  <head></head>
  <meta name="viewport" content="width=device-width" />
  <link rel="stylesheet" href="book.1.css" />
  <style>
    html {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      display: flex;
      flex-direction: column;
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #main {
      flex: 1;
      border-width: 0;
    }

    #menu {
      position: fixed;
      right: 0;
      bottom: 0;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
    }
    #menu.open {
      width: 90%;
      height: 80%;
      background-color: royalblue;
    }
    #menu [data-toggle] {
      border-radius: 6em 0 0 0;
      background-color: royalblue;
      width: 6em;
      height: 6em;
      position: absolute;
      right: 0;
      bottom: 0;
    }
    #menu:not(.open) > div {
      display: none;
    }

    #menu #toc {
      flex: 1;
      overflow: scroll;
    }
    #toc ol {
      list-style-type: none;
      margin: 0;
      padding: 0;
    }
    #toc ol ol {
      margin-left: 1.5em;
    }
    img {
      max-height: 100vh;
    }
  </style>
  <script src="book.bin.js"></script>
  <script>
    function makeTOC(chapters) {
      let s = "<ol>";
      for (const c of chapters) {
        s += `<li data-href="${c.href()}">` + c.title();
        if (c.children().length > 0) {
          s += makeTOC(c.children());
        }
        s += "</li>";
      }
      s += "</ol>";
      return s;
    }

    function main() {
      const containers = {
        toc: document.querySelector("#toc"),
        text: document.querySelector("#main")
      };
      const form = document.querySelector("form");
      const menu = document.querySelector("#menu");

      let book;

      async function renderTOC() {
        containers.toc.innerHTML = makeTOC(await book.toc());
      }

      async function loadBook() {
        const input = form.querySelector("input");
        const data = input.files[0];
        if (!data) {
          return;
        }
        // No need in FileReader, the underlying library takes care of it.
        book = await epub.Book.load(data);

        renderTOC();
        renderContent();
      }

      loadBook();

      async function renderContent() {
        const view = containers.text;

        const r = await book.convert();
        view.innerHTML = r;
        view.lang = "en";
      }

      function contentJump(href) {
        document.location.hash = href;
      }

      form.addEventListener("submit", async function(event) {
        event.preventDefault();
        loadBook();
      });

      menu
        .querySelector("[data-toggle]")
        .addEventListener("click", function(event) {
          menu.classList.toggle("open");
        });

      toc.addEventListener("click", function(event) {
        if (event.target.tagName.toLowerCase() != "li") {
          return;
        }
        const href = event.target.dataset["href"];
        contentJump(href);
      });

      enableHyphens(containers.text);
    }

    function enableHyphens(d) {
      if ("hyphens" in d.style) {
        d.style.hyphens = "auto";
        return;
      }
      if ("MozHyphens" in d.style) {
        d.style.MozHyphens = "auto";
        return;
      }
    }
  </script>
  <body>
    <div id="main"></div>
    <div id="menu">
      <div>
        <form>
          <input type="file" name="file" />
          <button>Open</button>
        </form>
        <div id="toc"></div>
      </div>
      <button data-toggle>Toggle</button>
    </div>
    <script>
      main();
    </script>
  </body>
</html>
